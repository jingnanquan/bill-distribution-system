{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///E:/offer/bill-distribution-system/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\r\nimport path from 'path';\r\n\r\nconst dbPath = path.join(process.cwd(), 'data', 'bill_system.db');\r\nconst db = new Database(dbPath);\r\n\r\nexport default db;\r\n"],"names":[],"mappings":";;;AAAA;AACA;;;AAEA,MAAM,SAAS,iGAAA,CAAA,UAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAChD,MAAM,KAAK,IAAI,2HAAA,CAAA,UAAQ,CAAC;uCAET","debugId":null}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///E:/offer/bill-distribution-system/lib/auth.ts"],"sourcesContent":["// lib/auth.ts\r\nimport CredentialsProvider from 'next-auth/providers/credentials';\r\nimport type { NextAuthOptions } from 'next-auth';\r\nimport db from './db';\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  session: { strategy: 'jwt' },\r\n  secret: process.env.NEXTAUTH_SECRET ?? 'devsecret',\r\n\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        username: { label: '用户名', type: 'text' },\r\n        password: { label: '密码', type: 'password' },\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials) return null;\r\n        const { username, password } = credentials;\r\n\r\n        const admin = db\r\n          .prepare(\r\n            `SELECT * FROM admin_users WHERE username = ? AND password = ?`,\r\n          )\r\n          .get(username, password);\r\n        if (admin)\r\n          return { id: admin.id, name: admin.name, role: 'admin' } as any;\r\n\r\n        const manager = db\r\n          .prepare(\r\n            `SELECT * FROM manager_users WHERE username = ? AND password = ?`,\r\n          )\r\n          .get(username, password);\r\n        if (manager)\r\n          return { id: manager.id, name: manager.name, role: 'manager' } as any;\r\n\r\n        const member = db\r\n          .prepare(\r\n            `SELECT * FROM member_users WHERE username = ? AND password = ?`,\r\n          )\r\n          .get(username, password);\r\n        if (member)\r\n          return { id: member.id, name: member.name, role: 'member' } as any;\r\n\r\n        return null;\r\n      },\r\n    }),\r\n  ],\r\n\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.role = (user as any).role;\r\n        token.name = user.name;\r\n      }\r\n      return token;\r\n    },\r\n\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.sub ? Number(token.sub) : undefined;\r\n        session.user.role = token.role as string;\r\n        session.user.name = token.name as string;\r\n      }\r\n      return session;\r\n    },\r\n  },\r\n\r\n  pages: { signIn: '/login' },\r\n};\r\n"],"names":[],"mappings":"AAAA,cAAc;;;;AACd;AAEA;;;AAEO,MAAM,cAA+B;IAC1C,SAAS;QAAE,UAAU;IAAM;IAC3B,QAAQ,QAAQ,GAAG,CAAC,eAAe,IAAI;IAEvC,WAAW;QACT,CAAA,GAAA,0JAAA,CAAA,UAAmB,AAAD,EAAE;YAClB,MAAM;YACN,aAAa;gBACX,UAAU;oBAAE,OAAO;oBAAO,MAAM;gBAAO;gBACvC,UAAU;oBAAE,OAAO;oBAAM,MAAM;gBAAW;YAC5C;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,OAAO;gBACzB,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;gBAE/B,MAAM,QAAQ,2GAAA,CAAA,UAAE,CACb,OAAO,CACN,CAAC,6DAA6D,CAAC,EAEhE,GAAG,CAAC,UAAU;gBACjB,IAAI,OACF,OAAO;oBAAE,IAAI,MAAM,EAAE;oBAAE,MAAM,MAAM,IAAI;oBAAE,MAAM;gBAAQ;gBAEzD,MAAM,UAAU,2GAAA,CAAA,UAAE,CACf,OAAO,CACN,CAAC,+DAA+D,CAAC,EAElE,GAAG,CAAC,UAAU;gBACjB,IAAI,SACF,OAAO;oBAAE,IAAI,QAAQ,EAAE;oBAAE,MAAM,QAAQ,IAAI;oBAAE,MAAM;gBAAU;gBAE/D,MAAM,SAAS,2GAAA,CAAA,UAAE,CACd,OAAO,CACN,CAAC,8DAA8D,CAAC,EAEjE,GAAG,CAAC,UAAU;gBACjB,IAAI,QACF,OAAO;oBAAE,IAAI,OAAO,EAAE;oBAAE,MAAM,OAAO,IAAI;oBAAE,MAAM;gBAAS;gBAE5D,OAAO;YACT;QACF;KACD;IAED,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,IAAI,GAAG,AAAC,KAAa,IAAI;gBAC/B,MAAM,IAAI,GAAG,KAAK,IAAI;YACxB;YACA,OAAO;QACT;QAEA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,GAAG,GAAG,OAAO,MAAM,GAAG,IAAI;gBAClD,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;gBAC9B,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YAChC;YACA,OAAO;QACT;IACF;IAEA,OAAO;QAAE,QAAQ;IAAS;AAC5B","debugId":null}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///E:/offer/bill-distribution-system/app/api/member/assignments/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getServerSession } from 'next-auth';\r\nimport { getToken } from 'next-auth/jwt';\r\nimport { authOptions } from '@/lib/auth';\r\nimport db from '@/lib/db';\r\nimport { parse } from 'url'; \r\n\r\nconst secret = process.env.NEXTAUTH_SECRET;\r\n\r\n/* ---------- 帮助函数：取得 memberId ---------- */\r\nasync function getMemberId(req: NextRequest): Promise<number | undefined> {\r\n  const session = await getServerSession(authOptions);\r\n  if (session?.user?.role === 'member' && session.user.id)\r\n    return session.user.id;\r\n\r\n  const token = await getToken({ req, secret });\r\n  if (token?.role === 'member' && token?.sub) return Number(token.sub);\r\n\r\n  return undefined;\r\n}\r\n\r\n/* ---------- GET /api/member/assignments ---------- */\r\n/* ---------- GET /api/member/assignments ---------- */\r\nexport async function GET(req: NextRequest) {\r\n  const memberId = await getMemberId(req);\r\n  if (!memberId) {\r\n    return NextResponse.json({ error: '无权限' }, { status: 403 });\r\n  }\r\n\r\n  const { searchParams } = new URL(req.url);\r\n  const month = searchParams.get('month');\r\n\r\n  let startDate: Date, endDate: Date;\r\n  if (month) {\r\n    const [year, monthIndex] = month.split('-').map(Number);\r\n    startDate = new Date(year, monthIndex - 1, 1);\r\n    endDate = new Date(year, monthIndex, 1);\r\n  } else {\r\n    const today = new Date();\r\n    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);\r\n    endDate = new Date(today.getFullYear(), today.getMonth(), 1);\r\n  }\r\n\r\n  const rows = db\r\n    .prepare(\r\n      `SELECT pa.*, p.title, p.language, p.minutes AS project_minutes,\r\n              p.deadline AS project_deadline\r\n         FROM project_assignments pa\r\n         JOIN projects p ON pa.project_id = p.id\r\n        WHERE pa.member_id = ?`\r\n    )\r\n    .all(memberId);\r\n\r\n  const pending = rows.filter((r: any) => r.status === 'pending');\r\n  const accepted = rows.filter((r: any) => r.status === 'accepted');\r\n\r\n  const completed = db\r\n    .prepare(\r\n      `SELECT pa.*, p.title, p.language, p.minutes AS project_minutes\r\n         FROM project_assignments pa\r\n         JOIN projects p ON pa.project_id = p.id\r\n        WHERE pa.member_id = ?\r\n          AND pa.status = 'completed'\r\n          AND pa.completed_time >= ?\r\n          AND pa.completed_time < ?`\r\n    )\r\n    .all(memberId, startDate.toISOString(), endDate.toISOString());\r\n\r\n  const skills = db\r\n    .prepare(\r\n      `SELECT language, task, price, rating\r\n         FROM member_skills\r\n        WHERE member_id = ?`\r\n    )\r\n    .all(memberId);\r\n\r\n  const availableMonths = db\r\n    .prepare(\r\n      `SELECT DISTINCT strftime('%Y-%m', completed_time) AS month\r\n         FROM project_assignments\r\n        WHERE member_id = ?\r\n          AND status = 'completed'\r\n          AND completed_time IS NOT NULL\r\n        ORDER BY completed_time DESC`\r\n    )\r\n    .all(memberId)\r\n    .map((row: any) => row.month);\r\n\r\n  return NextResponse.json({\r\n    pending,\r\n    accepted,\r\n    completed,\r\n    skills,\r\n    availableMonths,\r\n  });\r\n}\r\n\r\n/* ---------- PATCH /api/member/assignments ---------- */\r\nexport async function PATCH(req: NextRequest) {\r\n    const memberId = await getMemberId(req);\r\n    if (!memberId) {\r\n      return NextResponse.json({ error: '无权限' }, { status: 403 });\r\n    }\r\n  \r\n    const { assignmentId, action } = await req.json();\r\n    const assignment = db\r\n      .prepare(`SELECT * FROM project_assignments WHERE id = ?`)\r\n      .get(assignmentId);\r\n  \r\n    if (!assignment || assignment.member_id !== memberId) {\r\n      return NextResponse.json({ error: '任务不存在或无权限' }, { status: 404 });\r\n    }\r\n  \r\n    switch (action) {\r\n      case 'accept':\r\n        db.prepare(\r\n          `UPDATE project_assignments SET status = 'accepted' WHERE id = ?`,\r\n        ).run(assignmentId);\r\n        break;\r\n  \r\n      case 'reject':\r\n        db.prepare(\r\n          `UPDATE project_assignments SET status = 'rejected' WHERE id = ?`,\r\n        ).run(assignmentId);\r\n        break;\r\n  \r\n      case 'complete': {\r\n        const now = new Date();\r\n        const deadline = new Date(assignment.deadline);\r\n        let deductionNote: string | null = null;\r\n  \r\n        // 判断是否逾期\r\n        if (now > deadline) {\r\n          const diffDays = Math.ceil(\r\n            (now.getTime() - deadline.getTime()) / 86400000,\r\n          );\r\n          deductionNote = `超时${diffDays}天`;\r\n        }\r\n  \r\n        // 转换为北京时间\r\n        const bjTime = new Date(now.getTime() + 8 * 60 * 60 * 1000); // +8小时\r\n  \r\n        const formattedTime = bjTime.toISOString().replace('T', ' ').substring(0, 19); // '2025-06-02 12:34:56'\r\n  \r\n        db.prepare(\r\n          `UPDATE project_assignments\r\n             SET status = 'completed',\r\n                 completed_time = ?,\r\n                 deduction_note = ?\r\n           WHERE id = ?`,\r\n        ).run(formattedTime, deductionNote, assignmentId);\r\n        break;\r\n      }\r\n  \r\n      default:\r\n        return NextResponse.json({ error: '未知动作' }, { status: 400 });\r\n    }\r\n  \r\n    return NextResponse.json({ ok: true });\r\n  }\r\n  "],"names":[],"mappings":"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","debugId":null}}]
}