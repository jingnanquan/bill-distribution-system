{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 156, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Clementine/Desktop/bill-distribution-system/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\r\nimport path from 'path';\r\n\r\nconst dbPath = path.join(process.cwd(), 'data', 'bill_system.db');\r\nconst db = new Database(dbPath);\r\n\r\nexport default db;\r\n"],"names":[],"mappings":";;;AAAA;AACA;;;AAEA,MAAM,SAAS,iGAAA,CAAA,UAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AAChD,MAAM,KAAK,IAAI,2HAAA,CAAA,UAAQ,CAAC;uCAET","debugId":null}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Clementine/Desktop/bill-distribution-system/lib/auth.ts"],"sourcesContent":["import { getServerSession as nextAuthGetServerSession } from 'next-auth';\r\nimport CredentialsProvider from 'next-auth/providers/credentials';\r\nimport type { NextAuthOptions } from 'next-auth';\r\nimport db from './db';\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: 'Credentials',\r\n      credentials: {\r\n        username: { label: '用户名', type: 'text' },\r\n        password: { label: '密码', type: 'password' },\r\n      },\r\n      async authorize(credentials) {\r\n        const { username, password } = credentials;\r\n\r\n        // 管理员\r\n        const admin = db.prepare(`SELECT * FROM admin_users WHERE username = ? AND password = ?`).get(username, password);\r\n        if (admin) return { id: admin.id, name: admin.name, role: 'admin' };\r\n\r\n        // 项目经理\r\n        const manager = db.prepare(`SELECT * FROM manager_users WHERE username = ? AND password = ?`).get(username, password);\r\n        if (manager) return { id: manager.id, name: manager.name, role: 'manager' };\r\n\r\n        // 接单员\r\n        const member = db.prepare(`SELECT * FROM member_users WHERE username = ? AND password = ?`).get(username, password);\r\n        if (member) return { id: member.id, name: member.name, role: 'member' };\r\n\r\n        return null;\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id;       // ✅ 添加用户 ID\r\n        token.name = user.name;\r\n        token.role = user.role;\r\n      }\r\n      return token;\r\n    },\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.id;       // ✅ 将 token.id 传入 session\r\n        session.user.name = token.name;\r\n        session.user.role = token.role;\r\n      }\r\n      return session;\r\n    },\r\n  },\r\n  pages: {\r\n    signIn: '/login',\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET || 'devsecret',\r\n};\r\n\r\n// 工具函数：服务端获取 Session，用于 API 中\r\nexport function getServerSession(req?: any, res?: any) {\r\n  return nextAuthGetServerSession(req, res, authOptions);\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;;;;AAEO,MAAM,cAA+B;IAC1C,WAAW;QACT,CAAA,GAAA,0JAAA,CAAA,UAAmB,AAAD,EAAE;YAClB,MAAM;YACN,aAAa;gBACX,UAAU;oBAAE,OAAO;oBAAO,MAAM;gBAAO;gBACvC,UAAU;oBAAE,OAAO;oBAAM,MAAM;gBAAW;YAC5C;YACA,MAAM,WAAU,WAAW;gBACzB,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;gBAE/B,MAAM;gBACN,MAAM,QAAQ,2GAAA,CAAA,UAAE,CAAC,OAAO,CAAC,CAAC,6DAA6D,CAAC,EAAE,GAAG,CAAC,UAAU;gBACxG,IAAI,OAAO,OAAO;oBAAE,IAAI,MAAM,EAAE;oBAAE,MAAM,MAAM,IAAI;oBAAE,MAAM;gBAAQ;gBAElE,OAAO;gBACP,MAAM,UAAU,2GAAA,CAAA,UAAE,CAAC,OAAO,CAAC,CAAC,+DAA+D,CAAC,EAAE,GAAG,CAAC,UAAU;gBAC5G,IAAI,SAAS,OAAO;oBAAE,IAAI,QAAQ,EAAE;oBAAE,MAAM,QAAQ,IAAI;oBAAE,MAAM;gBAAU;gBAE1E,MAAM;gBACN,MAAM,SAAS,2GAAA,CAAA,UAAE,CAAC,OAAO,CAAC,CAAC,8DAA8D,CAAC,EAAE,GAAG,CAAC,UAAU;gBAC1G,IAAI,QAAQ,OAAO;oBAAE,IAAI,OAAO,EAAE;oBAAE,MAAM,OAAO,IAAI;oBAAE,MAAM;gBAAS;gBAEtE,OAAO;YACT;QACF;KACD;IACD,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE,EAAQ,YAAY;gBACtC,MAAM,IAAI,GAAG,KAAK,IAAI;gBACtB,MAAM,IAAI,GAAG,KAAK,IAAI;YACxB;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE,EAAQ,0BAA0B;gBAC5D,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;gBAC9B,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YAChC;YACA,OAAO;QACT;IACF;IACA,OAAO;QACL,QAAQ;IACV;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe,IAAI;AACzC;AAGO,SAAS,iBAAiB,GAAS,EAAE,GAAS;IACnD,OAAO,CAAA,GAAA,uIAAA,CAAA,mBAAwB,AAAD,EAAE,KAAK,KAAK;AAC5C","debugId":null}},
    {"offset": {"line": 255, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Clementine/Desktop/bill-distribution-system/app/api/manager/projects/route.ts"],"sourcesContent":["// 替换 getServerSession(authOptions) → getServerSession(req, res, authOptions)\r\n\r\nimport { getServerSession } from 'next-auth';\r\nimport { authOptions } from '@/lib/auth';\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const session = await getServerSession({ req, authOptions }); // ✅ 注意这里传入 req\r\n  const user = session?.user;\r\n\r\n  if (!user || user.role !== 'manager') {\r\n    return NextResponse.json({ error: '无权限' }, { status: 403 });\r\n  }\r\n\r\n  const projects = db.prepare(`SELECT * FROM projects WHERE manager_id = ?`).all(user.id);\r\n\r\n  for (const project of projects) {\r\n    const assignments = db.prepare(`SELECT * FROM project_assignments WHERE project_id = ?`).all(project.id);\r\n    project.assignments = assignments;\r\n  }\r\n\r\n  return NextResponse.json(projects);\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const session = await getServerSession({ req, authOptions }); // ✅ 同样传入 req\r\n    const user = session?.user;\r\n\r\n    if (!user || user.role !== 'manager') {\r\n      return NextResponse.json({ error: '无权限' }, { status: 403 });\r\n    }\r\n\r\n    const body = await req.json();\r\n    const { title, episode, language, minutes, deadline, assignments } = body;\r\n\r\n    if (!title || !episode || !language || !minutes || !deadline || !assignments) {\r\n      return NextResponse.json({ error: '字段不完整' }, { status: 400 });\r\n    }\r\n\r\n    const result = db.prepare(`\r\n      INSERT INTO projects (title, episode, language, minutes, deadline, manager_id)\r\n      VALUES (?, ?, ?, ?, ?, ?)\r\n    `).run(title, episode, language, minutes, deadline, user.id); // ✅ 这里才会有效果\r\n\r\n    const projectId = result.lastInsertRowid as number;\r\n\r\n    const assignStmt = db.prepare(`\r\n      INSERT INTO project_assignments (project_id, member_id, role, minutes, status, deadline)\r\n      VALUES (?, ?, ?, ?, ?, ?)\r\n    `);\r\n\r\n    for (const [role, memberId] of Object.entries(assignments)) {\r\n      assignStmt.run(projectId, Number(memberId), role, minutes / 4, 'pending', deadline);\r\n    }\r\n\r\n    return NextResponse.json({ ok: true });\r\n  } catch (error) {\r\n    console.error('创建项目失败:', error);\r\n    return NextResponse.json({ error: '内部错误' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,6EAA6E;;;;;AAE7E;AACA;;;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,UAAU,MAAM,CAAA,GAAA,uIAAA,CAAA,mBAAgB,AAAD,EAAE;QAAE;QAAK,aAAA,6GAAA,CAAA,cAAW;IAAC,IAAI,eAAe;IAC7E,MAAM,OAAO,SAAS;IAEtB,IAAI,CAAC,QAAQ,KAAK,IAAI,KAAK,WAAW;QACpC,OAAO,aAAa,IAAI,CAAC;YAAE,OAAO;QAAM,GAAG;YAAE,QAAQ;QAAI;IAC3D;IAEA,MAAM,WAAW,GAAG,OAAO,CAAC,CAAC,2CAA2C,CAAC,EAAE,GAAG,CAAC,KAAK,EAAE;IAEtF,KAAK,MAAM,WAAW,SAAU;QAC9B,MAAM,cAAc,GAAG,OAAO,CAAC,CAAC,sDAAsD,CAAC,EAAE,GAAG,CAAC,QAAQ,EAAE;QACvG,QAAQ,WAAW,GAAG;IACxB;IAEA,OAAO,aAAa,IAAI,CAAC;AAC3B;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,UAAU,MAAM,CAAA,GAAA,uIAAA,CAAA,mBAAgB,AAAD,EAAE;YAAE;YAAK,aAAA,6GAAA,CAAA,cAAW;QAAC,IAAI,aAAa;QAC3E,MAAM,OAAO,SAAS;QAEtB,IAAI,CAAC,QAAQ,KAAK,IAAI,KAAK,WAAW;YACpC,OAAO,aAAa,IAAI,CAAC;gBAAE,OAAO;YAAM,GAAG;gBAAE,QAAQ;YAAI;QAC3D;QAEA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG;QAErE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,YAAY,CAAC,WAAW,CAAC,YAAY,CAAC,aAAa;YAC5E,OAAO,aAAa,IAAI,CAAC;gBAAE,OAAO;YAAQ,GAAG;gBAAE,QAAQ;YAAI;QAC7D;QAEA,MAAM,SAAS,GAAG,OAAO,CAAC,CAAC;;;IAG3B,CAAC,EAAE,GAAG,CAAC,OAAO,SAAS,UAAU,SAAS,UAAU,KAAK,EAAE,GAAG,YAAY;QAE1E,MAAM,YAAY,OAAO,eAAe;QAExC,MAAM,aAAa,GAAG,OAAO,CAAC,CAAC;;;IAG/B,CAAC;QAED,KAAK,MAAM,CAAC,MAAM,SAAS,IAAI,OAAO,OAAO,CAAC,aAAc;YAC1D,WAAW,GAAG,CAAC,WAAW,OAAO,WAAW,MAAM,UAAU,GAAG,WAAW;QAC5E;QAEA,OAAO,aAAa,IAAI,CAAC;YAAE,IAAI;QAAK;IACtC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,WAAW;QACzB,OAAO,aAAa,IAAI,CAAC;YAAE,OAAO;QAAO,GAAG;YAAE,QAAQ;QAAI;IAC5D;AACF","debugId":null}}]
}