(()=>{var e={};e.id=499,e.ids=[499],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},41098:(e,t,r)=>{"use strict";r.d(t,{N:()=>n});var s=r(13581),a=r(77460);let n={session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET??"devsecret",providers:[(0,s.A)({name:"Credentials",credentials:{username:{label:"用户名",type:"text"},password:{label:"密码",type:"password"}},async authorize(e){if(!e)return null;let{username:t,password:r}=e,s=a.A.prepare("SELECT * FROM admin_users WHERE username = ? AND password = ?").get(t,r);if(s)return{id:s.id,name:s.name,role:"admin"};let n=a.A.prepare("SELECT * FROM manager_users WHERE username = ? AND password = ?").get(t,r);if(n)return{id:n.id,name:n.name,role:"manager"};let i=a.A.prepare("SELECT * FROM member_users WHERE username = ? AND password = ?").get(t,r);return i?{id:i.id,name:i.name,role:"member"}:null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role,e.name=t.name),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.sub?Number(t.sub):void 0,e.user.role=t.role,e.user.name=t.name),e)},pages:{signIn:"/login"}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63969:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>j,routeModule:()=>b,serverHooks:()=>R,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>A});var s={};r.r(s),r.d(s,{GET:()=>E,PATCH:()=>g});var a=r(96559),n=r(48088),i=r(37719),p=r(32190),o=r(19854),u=r(15912),l=r(41098),m=r(77460);let c=process.env.NEXTAUTH_SECRET;async function d(e){let t=await (0,o.getServerSession)(l.N);if(t?.user?.role==="member"&&t.user.id)return t.user.id;let r=await (0,u.getToken)({req:e,secret:c});if(r?.role==="member"&&r?.sub)return Number(r.sub)}async function E(e){let t,r,s=await d(e);if(!s)return p.NextResponse.json({error:"无权限"},{status:403});let{searchParams:a}=new URL(e.url),n=a.get("month");if(n){let[e,s]=n.split("-").map(Number);t=new Date(e,s-1,1),r=new Date(e,s,1)}else{let e=new Date;t=new Date(e.getFullYear(),e.getMonth()-1,1),r=new Date(e.getFullYear(),e.getMonth(),1)}let i=m.A.prepare(`SELECT pa.*, p.title, p.language, p.minutes AS project_minutes,
              p.deadline AS project_deadline
         FROM project_assignments pa
         JOIN projects p ON pa.project_id = p.id
        WHERE pa.member_id = ?`).all(s),o=i.filter(e=>"pending"===e.status),u=i.filter(e=>"accepted"===e.status),l=m.A.prepare(`SELECT pa.*, p.title, p.language, p.minutes AS project_minutes
         FROM project_assignments pa
         JOIN projects p ON pa.project_id = p.id
        WHERE pa.member_id = ?
          AND pa.status = 'completed'
          AND pa.completed_time >= ?
          AND pa.completed_time < ?`).all(s,t.toISOString(),r.toISOString()),c=m.A.prepare(`SELECT language, task, price, rating
         FROM member_skills
        WHERE member_id = ?`).all(s),E=m.A.prepare(`SELECT DISTINCT strftime('%Y-%m', completed_time) AS month
         FROM project_assignments
        WHERE member_id = ?
          AND status = 'completed'
          AND completed_time IS NOT NULL
        ORDER BY completed_time DESC`).all(s).map(e=>e.month);return p.NextResponse.json({pending:o,accepted:u,completed:l,skills:c,availableMonths:E})}async function g(e){let t=await d(e);if(!t)return p.NextResponse.json({error:"无权限"},{status:403});let{assignmentId:r,action:s}=await e.json(),a=m.A.prepare("SELECT * FROM project_assignments WHERE id = ?").get(r);if(!a||a.member_id!==t)return p.NextResponse.json({error:"任务不存在或无权限"},{status:404});switch(s){case"accept":m.A.prepare("UPDATE project_assignments SET status = 'accepted' WHERE id = ?").run(r);break;case"reject":m.A.prepare("UPDATE project_assignments SET status = 'rejected' WHERE id = ?").run(r);break;case"complete":{let e=new Date,t=new Date(a.deadline),s=null;if(e>t){let r=Math.ceil((e.getTime()-t.getTime())/864e5);s=`超时${r}天`}let n=new Date(e.getTime()+288e5).toISOString().replace("T"," ").substring(0,19);m.A.prepare(`UPDATE project_assignments
             SET status = 'completed',
                 completed_time = ?,
                 deduction_note = ?
           WHERE id = ?`).run(n,s,r);break}default:return p.NextResponse.json({error:"未知动作"},{status:400})}return p.NextResponse.json({ok:!0})}let b=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/member/assignments/route",pathname:"/api/member/assignments",filename:"route",bundlePath:"app/api/member/assignments/route"},resolvedPagePath:"E:\\offer\\test\\bill-distribution-system\\app\\api\\member\\assignments\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:A,serverHooks:R}=b;function j(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:A})}},74075:e=>{"use strict";e.exports=require("zlib")},77460:(e,t,r)=>{"use strict";r.d(t,{A:()=>p});let s=require("better-sqlite3");var a=r.n(s),n=r(33873);let i=r.n(n)().join(process.cwd(),"data","bill_system.db"),p=new(a())(i)},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[243,580,412],()=>r(63969));module.exports=s})();